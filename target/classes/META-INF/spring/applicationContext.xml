<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:sec="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
			http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
			http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-3.1.xsd
			http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd
			http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd">

	<import resource="classpath:META-INF/spring/sharedBeans.xml"/>

	<!-- Grab properties -->
	<context:property-placeholder
			location="classpath:tivity.properties"
			ignore-resource-not-found="true"
			ignore-unresolvable="false"
			system-properties-mode="OVERRIDE"/>

	<!-- Turn on annotations -->
	<context:component-scan base-package="com.silkstream"/>

	<!-- Turn on post-processing (Exception translation, etc) -->
	<context:annotation-config/>

	<mvc:annotation-driven/>

	<bean id="awsCreds" class="com.amazonaws.auth.BasicAWSCredentials">
		<constructor-arg index="0" value="AKIAIIGUCRCH2HAKFKYA"/>
		<constructor-arg index="1" value="oe3owx+q0OR/z2H13RqJCH8nnyZD/VCOZRL3Nyzn"/>
	</bean>


	<bean id="dynamoDBClient" class="com.silkstream.platform.factory.DynamoDBClientFactoryBean">
		<constructor-arg index="0" ref="awsCreds"/>
	</bean>


	<bean id="dynamoDBMapper" class="com.silkstream.platform.service.TivityMapperService">
		<constructor-arg index="0" ref="dynamoDBClient"/>
	</bean>

	<bean id="cloudSearchClient" class="com.amazonaws.services.cloudsearch.AmazonCloudSearchClient">
		<constructor-arg name="awsCredentials" ref="awsCreds"/>
	</bean>

	<bean id="amazonS3Client" class="com.amazonaws.services.s3.AmazonS3Client">
		<constructor-arg name="awsCredentials" ref="awsCreds"/>
	</bean>

	<!-- global model -->
	<bean id="global" class="com.silkstream.platform.models.BeanstalkProperties"/>

	<bean id="mapper" class="org.dozer.DozerBeanMapper"/>

	<!-- used for local development -->
	<bean id="amazonMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
		<property name="host" value="email-smtp.us-east-1.amazonaws.com"/>
		<property name="port" value="465"/>
		<property name="username" value="AKIAIYSTDRSMRIGD6TVQ"/>
		<property name="password" value="Aru+GjHmkkBPb/GXg98dEvVjzBg3wtk3+nlhw/ypBEPK"/>
		<property name="javaMailProperties">
			<props>
				<!-- Use SMTP transport protocol -->
				<prop key="mail.transport.protocol">smtp</prop>
				<!-- Use SMTP-AUTH to authenticate to SMTP server -->
				<prop key="mail.smtp.auth">true</prop>
				<!-- Use TLS to encrypt communication with SMTP server -->
				<prop key="mail.smtp.ssl.enable">true</prop>
				<prop key="mail.debug">true</prop>
			</props>
		</property>
	</bean>

	<!-- used for dev and prod -->
	<bean id="internalMailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
		<property name="host" value="mail.tivity.us"/>
		<property name="port" value="25"/>
		<property name="javaMailProperties">
			<props>
				<!-- Use SMTP transport protocol -->
				<prop key="mail.transport.protocol">smtp</prop>
				<!-- Use SMTP-AUTH to authenticate to SMTP server -->
				<!--<prop key="mail.smtp.auth">true</prop>-->
				<!-- Use TLS to encrypt communication with SMTP server -->
				<!--<prop key="mail.smtp.ssl.enable">true</prop>-->
				<prop key="mail.debug">true</prop>
			</props>
		</property>
	</bean>

	<task:annotation-driven executor="myExecutor" scheduler="myScheduler"/>
	<task:executor id="myExecutor" pool-size="5"/>
	<task:scheduler id="myScheduler" pool-size="10"/>

	<!-- SECURITY START -->

	<sec:global-method-security pre-post-annotations="enabled">
		<sec:expression-handler ref="methodSecurityExpressionHandler"/>
	</sec:global-method-security>

	<bean id="methodSecurityExpressionHandler"
	      class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler">
		<property name="roleHierarchy" ref="roleHierarchy"/>
	</bean>

	<http use-expressions="true" auto-config="false" entry-point-ref="authenticationProcessingFilterEntryPoint"
	      xmlns="http://www.springframework.org/schema/security">
		<sec:custom-filter position="FORM_LOGIN_FILTER" ref="authenticationFilter"/>
		<sec:custom-filter position="REMEMBER_ME_FILTER" ref="rememberMeFilter"/>
		<sec:custom-filter position="LOGOUT_FILTER" ref="rememberMeLogoutFilter"/>
		<access-denied-handler ref="myAccessDeniedHandler"/>
		<anonymous/>
	</http>
	<bean id="myAccessDeniedHandler" class="org.springframework.security.web.access.AccessDeniedHandlerImpl">
		<property name="errorPage" value="/public/403.htm"/>
	</bean>

	<bean id="authenticationFilter" class="com.silkstream.platform.security.AuthentificationFilterImpl">
		<property name="authenticationManager" ref="authenticationManager"/>
		<property name="filterProcessesUrl" value="/api/security/login"/>
		<property name="rememberMeServices" ref="rememberMeServices"/>
		<property name="authenticationFailureHandler" ref="authenticationFailureHandler"/>
		<property name="authenticationSuccessHandler" ref="authenticationSuccessHandler"/>
	</bean>

	<bean id="authenticationProcessingFilterEntryPoint"
	      class="org.springframework.security.web.authentication.Http403ForbiddenEntryPoint">
	</bean>

	<bean id="authenticationSuccessHandler" class="com.silkstream.platform.security.AuthenticationSuccessHandler">
		<property name="defaultTargetUrl" value="/"/>
	</bean>

	<bean id="authenticationFailureHandler" class="com.silkstream.platform.security.AuthenticationFailureHandler"/>

	<authentication-manager alias="authenticationManager" xmlns="http://www.springframework.org/schema/security">
		<authentication-provider user-service-ref="userDetailsService">
			<password-encoder ref="encoder">
				<salt-source ref="saltSource"/>
			</password-encoder>
		</authentication-provider>
		<authentication-provider ref="rememberMeAuthenticationProvider"/>
	</authentication-manager>

	<bean id="userDetailsService" class="com.silkstream.platform.security.AuthenticationService"/>

	<bean id="rememberMeLogoutFilter" class="org.springframework.security.web.authentication.logout.LogoutFilter">
		<constructor-arg name="logoutSuccessUrl" value="/" />
		<constructor-arg name="handlers">
			<list>
				<ref bean="rememberMeServices"/>
				<bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler"/>
			</list>
		</constructor-arg>
		<property name="filterProcessesUrl" value="/api/user/logout"/>
	</bean>

	<bean id="rememberMeFilter" class=
			"com.silkstream.platform.security.TivityRememberMeAuthenticationFilter">
		<constructor-arg name="rememberMeServices" ref="rememberMeServices"/>
		<constructor-arg name="authenticationManager" ref="authenticationManager"/>
	</bean>

	<bean id="rememberMeServices" class="org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices">
		<constructor-arg name="userDetailsService" ref="userDetailsService"/>
		<constructor-arg name="key" value="7A57D7F17CE595F6CCE75E31CC2851CF5C6B55AC8443791BF745E2F3E83FCD9B"/>
		<property name="parameter" value="rememberme"/>
		<property name="cookieName" value="TIVITY_REMEMBER_ME"/>
		<property name="alwaysRemember" value="true"/>
		<property name="tokenValiditySeconds" value="2678400"/><!--REMEMBER USER FOR A MONTH-->
	</bean>

	<bean id="rememberMeAuthenticationProvider"
	      class="org.springframework.security.authentication.RememberMeAuthenticationProvider">
		<constructor-arg name="key" value="7A57D7F17CE595F6CCE75E31CC2851CF5C6B55AC8443791BF745E2F3E83FCD9B"/>
	</bean>

	<bean id="accessDecisionManager" class="org.springframework.security.access.vote.UnanimousBased"
	      xmlns="http://www.springframework.org/schema/beans">
		<constructor-arg>
			<list>
				<bean class="org.springframework.security.oauth2.provider.vote.ScopeVoter"/>
				<bean class="org.springframework.security.access.vote.AuthenticatedVoter"/>
				<bean class="org.springframework.security.access.vote.RoleHierarchyVoter">
					<constructor-arg ref="roleHierarchy"/>
					<property name="rolePrefix" value=""/>
				</bean>
			</list>
		</constructor-arg>
	</bean>

	<!-- DISABLE CACHING FOR SERVICES -->
	<mvc:interceptors>
		<bean id="webContentInterceptor" class="org.springframework.web.servlet.mvc.WebContentInterceptor">
			<property name="cacheSeconds" value="0"/>
			<property name="useExpiresHeader" value="true"/>
			<property name="useCacheControlHeader" value="true"/>
			<property name="useCacheControlNoStore" value="true"/>
		</bean>
	</mvc:interceptors>

	<bean id="connectionFactoryLocator" class="org.springframework.social.connect.support.ConnectionFactoryRegistry">
		<property name="connectionFactories">
			<list>
				<bean class="org.springframework.social.facebook.connect.FacebookConnectionFactory">
					<constructor-arg value="103127473159068"/>
					<constructor-arg value="d6825c6b7c6df34b1cb299ba4625bdad"/>
				</bean>
			</list>
		</property>
	</bean>

	<bean id="connectionConverter" class="com.silkstream.platform.security.social.ConnectionConverter">
		<constructor-arg index="0" ref="connectionFactoryLocator"/>
		<constructor-arg index="1" ref="textEncryptor"/>
	</bean>
	<bean id="dynamoDBConnectionService" class="com.silkstream.platform.security.social.DynamoDBConnectionService"></bean>

	<bean id="dynamoUsersConnectionRepository"
	      class="com.silkstream.platform.security.social.DynamoDBUsersConnectionRepository">
		<constructor-arg index="0" ref="dynamoDBConnectionService"/>
		<constructor-arg index="1" ref="connectionFactoryLocator"/>
		<property name="connectionSignUp" ref="signUp"/>
	</bean>

	<bean id="textEncryptor" class="org.springframework.security.crypto.encrypt.Encryptors" factory-method="noOpText"/>
	<bean id="signUp" class="com.silkstream.platform.security.social.TivityConnectionSignUp"></bean>
	<!-- SECURITY END -->

</beans>